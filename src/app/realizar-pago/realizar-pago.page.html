<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/lista-clientes"></ion-back-button>
    </ion-buttons>
    <ion-title>Pagar Servicio</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>Información del Pago</ion-card-title>
      <ion-card-subtitle>Complete los datos del servicio a pagar</ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <form (ngSubmit)="realizarPago()">
        <!-- Proveedor -->
        <ion-item>
          <ion-label>Proveedor *</ion-label>
          <ion-select 
            [(ngModel)]="pago.proveedorId" 
            name="proveedorId" 
            (ionChange)="onProveedorChange()"
            interface="popover"
          >
            <ion-select-option *ngFor="let prov of proveedores" [value]="prov.id">
              {{ prov.nombre }} ({{ prov.tipoServicio }})
            </ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Info del proveedor seleccionado -->
        <ion-item *ngIf="proveedorSeleccionado" lines="none" class="info-proveedor">
          <ion-label class="ion-text-wrap">
            <p><strong>Formato:</strong> {{ proveedorSeleccionado.formatoContrato }}</p>
            <p><strong>Longitud:</strong> {{ proveedorSeleccionado.longitudMinima }} - {{ proveedorSeleccionado.longitudMaxima }} dígitos</p>
          </ion-label>
        </ion-item>

        <!-- Número de contrato -->
        <ion-item>
          <ion-label position="floating">Número de Contrato *</ion-label>
          <ion-input
            type="text"
            [(ngModel)]="pago.numeroContrato"
            name="numeroContrato"
            required
            [disabled]="!proveedorSeleccionado"
          ></ion-input>
        </ion-item>

        <ion-note *ngIf="pago.numeroContrato && !validarContrato()" color="danger" class="ion-padding-start">
          Número de contrato inválido
        </ion-note>

        <!-- Monto -->
        <ion-item>
          <ion-label position="floating">Monto *</ion-label>
          <ion-input
            type="number"
            [(ngModel)]="pago.monto"
            name="monto"
            required
            min="0"
            step="0.01"
          ></ion-input>
        </ion-item>

        <!-- Cuenta origen -->
        <ion-item>
          <ion-label position="floating">ID Cuenta Origen *</ion-label>
          <ion-input
            type="number"
            [(ngModel)]="pago.cuentaOrigenId"
            name="cuentaOrigenId"
            required
          ></ion-input>
        </ion-item>

        <!-- Pago programado -->
        <ion-item>
          <ion-label>¿Programar pago?</ion-label>
          <ion-toggle [(ngModel)]="esPagoProgramado" name="esPagoProgramado"></ion-toggle>
        </ion-item>

        <!-- Fecha programada -->
        <ion-item *ngIf="esPagoProgramado">
          <ion-label>Fecha de Pago *</ion-label>
          <ion-datetime
            [(ngModel)]="pago.fechaProgramada"
            name="fechaProgramada"
            display-format="DD/MM/YYYY"
            [min]="fechaMinima"
            [max]="fechaMaxima"
          ></ion-datetime>
        </ion-item>

        <ion-note *ngIf="esPagoProgramado" color="medium" class="ion-padding">
          Los pagos programados pueden cancelarse hasta 24 horas antes de la fecha programada.
        </ion-note>

        <ion-button 
          expand="block" 
          type="submit" 
          class="ion-margin-top"
          [disabled]="!validarFormulario() || !validarContrato()"
        >
          {{ esPagoProgramado ? 'Programar Pago' : 'Pagar Ahora' }}
        </ion-button>

        <ion-button expand="block" fill="outline" (click)="volver()" class="ion-margin-top">
          Cancelar
        </ion-button>
      </form>
    </ion-card-content>
  </ion-card>
</ion-content>
